<!doctype html>
<html lang=en>
<head>
<meta charset=utf-8>
<title>blah</title>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/jscolor/2.4.6/jscolor.min.js"></script> 

<style type="text/css">
  .theme-preview{
    float: right;
  }

  .theme-preview.awaiting-update{
    filter: blur(5px);
    background-color: grey;
  }

  #theme-form label{
    width: 10em;
    text-align: right;
    display: inline-block;
  }

</style>

</head>
<body>
  <form id="theme-form">

    <label for="theme-input-logo_name">Logo Name</label>
    <select name="logo_name" id="theme-input-logo_name">
      <option value="" selected>none</option>
      <option value="fox">fox</option>
      <option value="sealg">sealg</option>
      <option value="three">three</option>
      <option value="stag">stag</option>
      <option value="prosthetic">prosthetic</option>
      <option value="factorym">factorym</option>
      <option value="drainagem">drainagem</option>
    </select><br/>

    <label for="theme-input-base">Base Color</label>
    <input id="theme-input-base" name="base" data-jscolor="" value="#00000000"><br/>

    <label for="theme-input-stripe">Stripe Color</label>
    <input id="theme-input-stripe" name="stripe" data-jscolor="" value="#00000000"><br/>

    <label for="theme-input-logo">Logo Color</label>
    <input id="theme-input-logo" name="logo" data-jscolor="" value="#00000000"><br/>

    <label for="theme-input-cab_base">Cab Base Color</label>
    <input id="theme-input-cab_base" name="cab_base" data-jscolor="" value="#00000000"><br/>

    <label for="theme-input-cab_stripe_base">Cab Stripe Base Color</label>
    <input id="theme-input-cab_stripe_base" name="cab_stripe_base" data-jscolor="" value="#00000000"><br/>

  </form>

  <img class="theme-preview" data-theme-preview-url="/preview/covered_ifa_w50/covered.dds"></img>

  <img class="theme-preview" data-theme-preview-url="/preview/open_kmz_5320/base.dds"></img>

  <a id="download-bundle" href="/bundle">Download bundle</a>

  <script type="text/javascript">

    function debounce(func, wait, immediate) {
      var timeout;

      return function executedFunction() {
        var context = this;
        var args = arguments;
          
        var later = function() {
          timeout = null;
          if (!immediate) func.apply(context, args);
        };

        var callNow = immediate && !timeout;
      
        clearTimeout(timeout);

        timeout = setTimeout(later, wait);
      
        if (callNow) func.apply(context, args);
      };
    };

    var theme_previews = document.getElementsByClassName("theme-preview");

    var getThemeParams = function() {
      var form_data = new FormData(document.getElementById('theme-form'))
      return(new URLSearchParams(form_data).toString());
    }
    
    var updateThemePreview = function(){
      var theme_params =  getThemeParams();
      Array.from(theme_previews).forEach(e => e['src'] = e['dataset']['themePreviewUrl'] + '?' + theme_params);
    }

    var debouncedUpdateThemePreview = debounce(updateThemePreview, 500, false);

    var updateBundleLink = function(){
      document.getElementById("download-bundle")['href'] = '/bundle?' + getThemeParams();
    }

    var themePreviewDidLoad = function(evt){
      evt.target.classList.remove('awaiting-update');
    }

    Array.from(theme_previews).forEach(e => e.addEventListener('loadend', themePreviewDidLoad));

    var themeFormDidChange = function(e){
      Array.from(theme_previews).forEach(e => e.classList.add('awaiting-update'));
      debouncedUpdateThemePreview();
      updateBundleLink();

      if(e != null){
        const params = new URLSearchParams(location.search);
        params.set(e.target['name'], e.target['value']);
        window.history.replaceState({}, '', `${location.pathname}?${params}`);
      }
    }

    const params = new URLSearchParams(location.search);
    for (let p of params){
      var pe = document.getElementById("theme-input-"+p[0]);
      if(pe != null){
        pe['value'] = p[1];
      }
    }

    var themeFormInputs = document.getElementById("theme-form").getElementsByTagName("input");
    Array.from(themeFormInputs).forEach(i => addEventListener('input', themeFormDidChange));

    themeFormDidChange();

  </script>

</body>
</html>