<!doctype html>
<html lang=en>
<head>
<meta charset=utf-8>
<title>blah</title>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/jscolor/2.4.6/jscolor.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700&display=swap" rel="stylesheet">  

<style type="text/css">

  html{
    font-family: 'Josefin Sans', sans-serif;
  }

  .theme-preview{
    max-width: 100%;
  }

  .theme-preview.awaiting-update{
    filter: blur(5px);
    background-color: grey;
  }

  #theme-form label{
    width: 10em;
    padding-top: 0.5em;
    text-align: right;
    display: inline-block;
  }

  #theme-form input, #theme-form select{
    width: 9.5em;
  }

  #theme-form input.jscolor{
    width: 6em;
    font-family: monospace;
    color: #aaa;
  }

  #theme-form fieldset{
    margin-bottom: 1em;
  }

  body{
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
  }

  #lefthand{
    padding: 1em;
  }

  #download-bundle{
    display: inline-block;
    width: 100%;
    text-align: center;
    padding: 1em 0em;
  }

</style>

</head>
<body>

  <div id="lefthand">
    <form id="theme-form">

      <fieldset>
        <legend>Common</legend>

        <label for="theme-input-logo_name">Logo Name</label>
        <select name="logo_name" id="theme-input-logo_name">
          <option value="" selected>none</option>
          <option value="fox">fox</option>
          <option value="sealg">sealg</option>
          <option value="three">three</option>
          <option value="stag">stag</option>
          <option value="prosthetic">prosthetic</option>
          <option value="factorym">factorym</option>
          <option value="drainagem">drainagem</option>
          <option value="baking">baking</option>
          <option value="chickenv">chickenv</option>
          <option value="fishfood">fishfood</option>
          <option value="grapes">grapes</option>
          <option value="metal">metal</option>
          <option value="pp">pp</option>
          <option value="sunman">sunman</option>
          <option value="textind">textind</option>
        </select><br/>
      </fieldset>

      <fieldset>
        <legend>Truck Bodies</legend>
        <label for="theme-input-base">Body Base</label>
        <input id="theme-input-base" name="base" data-jscolor="" value="#00000000"><br/>

        <label for="theme-input-stripe">Body Stripe</label>
        <input id="theme-input-stripe" name="stripe" data-jscolor="" value="#00000000"><br/>

        <label for="theme-input-wooden_hull_base">Lower Body/Bed</label>
        <input id="theme-input-wooden_hull_base" name="wooden_hull_base" data-jscolor="" value="#00000000"><br/>

        <label for="theme-input-logo">Body Logo</label>
        <input id="theme-input-logo" name="logo" data-jscolor="" value="#00000000"><br/>

      </fieldset>

      <fieldset>
        <legend>Truck Cabs</legend>

        <label for="theme-input-cab_base">Cab Base</label>
        <input id="theme-input-cab_base" name="cab_base" data-jscolor="" value="#00000000"><br/>

        <label for="theme-input-cab_stripe_base">Cab Stripe Base</label>
        <input id="theme-input-cab_stripe_base" name="cab_stripe_base" data-jscolor="" value="#00000000"><br/>

        <label for="theme-input-cab_stripe_logo">Cab Stripe Logo</label>
        <input id="theme-input-cab_stripe_logo" name="cab_stripe_logo" data-jscolor="" value="#00000000"><br/>

    </fieldset>

    </form>
    <a id="download-bundle" href="/bundle">Download bundle</a>

  </div>

  <div id="righthand">
    <img class="theme-preview" data-theme-preview-url="/preview/preview/ifa_w_50.png"></img>
  </div>


  <script type="text/javascript">

    function debounce(func, wait, immediate) {
      var timeout;

      return function executedFunction() {
        var context = this;
        var args = arguments;
          
        var later = function() {
          timeout = null;
          if (!immediate) func.apply(context, args);
        };

        var callNow = immediate && !timeout;
      
        clearTimeout(timeout);

        timeout = setTimeout(later, wait);
      
        if (callNow) func.apply(context, args);
      };
    };

    var theme_previews = document.getElementsByClassName("theme-preview");

    var getThemeParams = function() {
      var form_data = new FormData(document.getElementById('theme-form'))
      return(new URLSearchParams(form_data).toString());
    }
    
    var updateThemePreview = function(){
      var theme_params =  getThemeParams();
      Array.from(theme_previews).forEach(e => e['src'] = e['dataset']['themePreviewUrl'] + '?' + theme_params);
    }

    var debouncedUpdateThemePreview = debounce(updateThemePreview, 500, false);

    var updateBundleLink = function(){
      document.getElementById("download-bundle")['href'] = '/bundle?' + getThemeParams();
    }

    var themePreviewDidLoad = function(evt){
      evt.target.classList.remove('awaiting-update');
    }

    Array.from(theme_previews).forEach(e => e.addEventListener('load', themePreviewDidLoad));

    var themeFormDidChange = function(e){
      Array.from(theme_previews).forEach(e => e.classList.add('awaiting-update'));
      debouncedUpdateThemePreview();
      updateBundleLink();

      if(e != null){
        const params = new URLSearchParams(location.search);
        params.set(e.target['name'], e.target['value']);
        window.history.replaceState({}, '', `${location.pathname}?${params}`);
      }
    }

    const params = new URLSearchParams(location.search);
    for (let p of params){
      var pe = document.getElementById("theme-input-"+p[0]);
      if(pe != null){
        pe['value'] = p[1];
      }
    }

    var themeFormInputs = document.getElementById("theme-form").getElementsByTagName("input");
    Array.from(themeFormInputs).forEach(i => addEventListener('input', themeFormDidChange));

    themeFormDidChange();

  </script>

</body>
</html>